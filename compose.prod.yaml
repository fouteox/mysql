---
services:
  app:
    image: ${IMAGE_NAME:-app}:latest
    build:
      target: app
    secrets:
      - source: laravel_env
        target: /var/www/html/.env
        uid: "33"
        gid: "33"
        mode: 0440
    ulimits:
      nofile:
        soft: 20000
        hard: 40000
    volumes:
      - 'storage_private:/var/www/html/storage/app/private'
      - 'storage_public:/var/www/html/storage/app/public'
      - 'storage_sessions:/var/www/html/storage/framework/sessions'
      - 'storage_logs:/var/www/html/storage/logs'
    logging:
      driver: 'json-file'
      options:
        max-size: "50m"
        max-file: "6"
    environment:
      AUTORUN_ENABLED: "true"
      PHP_OPCACHE_ENABLE: "1"
      HEALTHCHECK_PATH: "/up"
      INERTIA_SSR_URL: "http://ssr:13714"
      INERTIA_SSR_ENSURE_BUNDLE_EXISTS: "false"
    networks:
      - internal
      - proxy
    healthcheck:
      start_period: 90s
      interval: 10s
      timeout: 10s
      retries: 3
    deploy:
      replicas: 1
      update_config:
        failure_action: rollback
        parallelism: 1
        delay: 5s
        order: start-first
      rollback_config:
        parallelism: 1
        order: stop-first
      restart_policy:
        condition: any
        delay: 10s
        max_attempts: 3
        window: 120s
      labels:
        - "traefik.enable=true"
        - "traefik.swarm.lbswarm=true"
        - "traefik.swarm.network=proxy"
        - "traefik.http.routers.mysql.rule=Host(`${APP_HOST}`)"
        - "traefik.http.services.mysql.loadbalancer.server.port=8080"
  queue:
    image: ${IMAGE_NAME:-app}:latest
    command: ["php", "/var/www/html/artisan", "queue:work", "--sleep=3", "--tries=3", "--max-time=3600"]
    secrets:
      - source: laravel_env
        target: /var/www/html/.env
        uid: "33"
        gid: "33"
        mode: 0440
    ulimits:
      nofile:
        soft: 20000
        hard: 40000
    volumes:
      - 'storage_private:/var/www/html/storage/app/private'
      - 'storage_public:/var/www/html/storage/app/public'
      - 'storage_sessions:/var/www/html/storage/framework/sessions'
      - 'storage_logs:/var/www/html/storage/logs'
    logging:
      driver: 'json-file'
      options:
        max-size: "50m"
        max-file: "6"
    networks:
      - internal
    healthcheck:
      test: ["CMD", "healthcheck-queue"]
      start_period: 10s
      interval: 30s
      timeout: 5s
      retries: 2
    deploy:
      replicas: 1
      update_config:
        failure_action: rollback
        parallelism: 1
        delay: 5s
        order: stop-first
      rollback_config:
        parallelism: 1
        order: stop-first
      restart_policy:
        condition: any
        delay: 10s
        max_attempts: 3
        window: 120s
  ssr:
    image: ${IMAGE_NAME:-app}:ssr
    build:
      target: ssr
    networks:
      - internal
    logging:
      driver: 'json-file'
      options:
        max-size: "50m"
        max-file: "6"
    healthcheck:
      test: ["CMD", "bun", "-e", "fetch('http://localhost:13714/health').then(r => process.exit(r.ok ? 0 : 1)).catch(() => process.exit(1))"]
      start_period: 5s
      interval: 5s
      timeout: 5s
      retries: 2
    deploy:
      replicas: 1
      update_config:
        failure_action: rollback
        order: start-first
      restart_policy:
        condition: any
        delay: 5s
        max_attempts: 3
  mysql:
    image: mysql:9
    ulimits:
      nofile:
        soft: 20000
        hard: 40000
    environment:
      MYSQL_RANDOM_ROOT_PASSWORD: "1"
      MYSQL_DATABASE: "${DB_DATABASE}"
      MYSQL_USER: "${DB_USERNAME}"
      MYSQL_PASSWORD: "${DB_PASSWORD}"
    volumes:
      - 'stack-mysql:/var/lib/mysql'
      - 'backup_dumps:/dumps'
    networks:
      - internal
    logging:
      driver: 'json-file'
      options:
        max-size: "50m"
        max-file: "6"
    healthcheck:
      test: ["CMD", "mysqladmin", "ping", "-h", "localhost", "-u${DB_USERNAME}", "-p${DB_PASSWORD}"]
      start_period: 10s
      interval: 10s
      timeout: 5s
      retries: 3
    labels:
      - docker-volume-backup.archive-pre=/bin/sh -c 'mysqldump -u $$MYSQL_USER -p$$MYSQL_PASSWORD --single-transaction --set-gtid-purged=OFF --no-tablespaces $$MYSQL_DATABASE > /dumps/mysql.sql'
      - docker-volume-backup.exec-label=mysql
    deploy:
      replicas: 1
      placement:
        constraints:
          - node.role==manager
  backup:
    image: offen/docker-volume-backup:v2
    environment:
      # S3 / S3-compatible storage
      AWS_S3_BUCKET_NAME: "${BACKUP_S3_BUCKET:-}"
      AWS_S3_PATH: "${BACKUP_S3_PATH:-}"
      AWS_ACCESS_KEY_ID: "${BACKUP_AWS_ACCESS_KEY_ID:-}"
      AWS_SECRET_ACCESS_KEY: "${BACKUP_AWS_SECRET_ACCESS_KEY:-}"
      AWS_ENDPOINT: "${BACKUP_AWS_ENDPOINT:-}"
      AWS_DEFAULT_REGION: "${BACKUP_AWS_DEFAULT_REGION:-}"
      # Dropbox
      DROPBOX_REMOTE_PATH: "${BACKUP_DROPBOX_REMOTE_PATH:-}"
      DROPBOX_APP_KEY: "${BACKUP_DROPBOX_APP_KEY:-}"
      DROPBOX_APP_SECRET: "${BACKUP_DROPBOX_APP_SECRET:-}"
      DROPBOX_REFRESH_TOKEN: "${BACKUP_DROPBOX_REFRESH_TOKEN:-}"
      # Common
      BACKUP_CRON_EXPRESSION: "0 3 * * *"
      BACKUP_RETENTION_DAYS: "${BACKUP_RETENTION_DAYS:-7}"
      EXEC_LABEL: "mysql"
    volumes:
      - backup_dumps:/backup/dumps:ro
      - storage_logs:/backup/logs:ro
      - /var/run/docker.sock:/var/run/docker.sock:ro
    networks:
      - internal
    logging:
      driver: 'json-file'
      options:
        max-size: "50m"
        max-file: "6"
    deploy:
      replicas: 1
      placement:
        constraints:
          - node.role==manager
      resources:
        limits:
          memory: 256M
volumes:
  stack-mysql:
  storage_private:
  storage_public:
  storage_sessions:
  storage_logs:
  backup_dumps:
networks:
  internal:
  proxy:
    external: true
secrets:
  laravel_env:
    file: .env.production
    name: laravel_env_${ENV_HASH:-latest}
